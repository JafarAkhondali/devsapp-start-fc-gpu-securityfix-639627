edition: 3.0.0
name: modelscope-coldstart
# access是当前应用所需要的密钥信息配置：
# 密钥配置请参见：https://www.serverless-devs.com/serverless-devs/command/config
# 密钥使用请参见：https://www.serverless-devs.com/serverless-devs/tool
access: {{ access }}

vars: # 全局变量
  region: {{ region }}
  version: fc-deploy-common-v17
  name: modelscope # {{ name }}
  description: "modelscope deployment using multiple functions"
  ppSize: "{{ funcNumber }}"
  destppSize: "{{ destFuncNumber }}"
  role: {{ roleArn }}
  vCPU: 4
  gpuInstanceType: fc.gpu.tesla.1 # {{ gpuInstanceType }}
  gpuMemorySize: 16384 # {{ gpuMemorySize }}
  memorySize: 32768 # {{ memorySize }}
  concurrency: 16
  modelID: {{ modelId }}
  modelTask: chat
  modelRevision: {{ modelRevision }}
  localModelCache: /mnt/model-cache
  CommDir: /mnt/comm
  vpcConfig:
    vpcId: ${resources.modelscope-stack.output.VpcID}
    securityGroupId: ${resources.modelscope-stack.output.securityGroupId}
    vSwitchIds:
      - ${resources.modelscope-stack.output.switchId}
  nasServerAddr-0: ${resources.modelscope-stack.output.MT1}:/
  nasServerAddr-1: ${resources.modelscope-stack.output.MT2}:/
  nasServerAddr-2: ${resources.modelscope-stack.output.MT3}:/
  nasServerAddr-3: ${resources.modelscope-stack.output.MT4}:/
  nasServerAddr-4: ${resources.modelscope-stack.output.MT5}:/
  nasServerAddr-5: ${resources.modelscope-stack.output.MT6}:/
  nasServerAddr-6: ${resources.modelscope-stack.output.MT7}:/
  nasServerAddr-7: ${resources.modelscope-stack.output.MT8}:/

resources:
  modelscope-stack:
    component: ros
    props:
      region: ${vars.region}
      name: modelscope-stack
      template: ./modelscope_stack_template.yaml
      parameters:
        FuncNumber: ${vars.ppSize}
  model_download_func_0:
    component: 'fc3'
    actions:
      complete-deploy:
        - component: fc3 invoke
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-download-func-0
      description: initialize model into nas storage
      timeout: 86400
      memorySize: 32768
      cpu: 8
      diskSize: 10240
      instanceConcurrency: 1
      runtime: custom-container
      internetAccess: true
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart-download:v1
        port: 9000
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-0}model-cache
            mountDir: /mnt/model-cache-0
          - serverAddr: ${vars.nasServerAddr-1}model-cache
            mountDir: /mnt/model-cache-1
          - serverAddr: ${vars.nasServerAddr-2}model-cache
            mountDir: /mnt/model-cache-2
          - serverAddr: ${vars.nasServerAddr-3}model-cache
            mountDir: /mnt/model-cache-3
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODEL_VERSION: ${vars.modelRevision}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        MODELSCOPE_TOKEN: {{ accessToken }}
        MODELSCOPE_DOMAIN: www.modelscope.cn # {{ modelCache }}
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        MODEL_PART: "0"
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  model_download_func_1:
    component: 'fc3'
    actions:
      complete-deploy:
        - component: fc3 invoke
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-download-func-1
      description: initialize model into nas storage
      timeout: 86400
      memorySize: 32768
      cpu: 8
      diskSize: 10240
      instanceConcurrency: 1
      runtime: custom-container
      internetAccess: true
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart-download:v1
        port: 9000
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-0}model-cache
            mountDir: /mnt/model-cache-0
          - serverAddr: ${vars.nasServerAddr-4}model-cache
            mountDir: /mnt/model-cache-4
          - serverAddr: ${vars.nasServerAddr-5}model-cache
            mountDir: /mnt/model-cache-5
          - serverAddr: ${vars.nasServerAddr-6}model-cache
            mountDir: /mnt/model-cache-6
          - serverAddr: ${vars.nasServerAddr-7}model-cache
            mountDir: /mnt/model-cache-7
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODEL_VERSION: ${vars.modelRevision}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        MODELSCOPE_TOKEN: {{ accessToken }}
        MODELSCOPE_DOMAIN: www.modelscope.cn # {{ modelCache }}
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        MODEL_PART: "1"
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_7:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail8}
      description: Deploy ModelScope applications of model (stage 7)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-7}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '7'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_6:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail7}
      description: Deploy ModelScope applications of model (stage 6)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-6}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '6'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_5:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail6}
      description: Deploy ModelScope applications of model (stage 5)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-5}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '5'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_4:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail5}
      description: Deploy ModelScope applications of model (stage 4)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig: 
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-4}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '4'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_3:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail4}
      description: Deploy ModelScope applications of model (stage 3)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-3}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '3'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_2:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail3}
      description: Deploy ModelScope applications of model (stage 2)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-2}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '2'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_1:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func${resources.modelscope-stack.output.funcTail2}
      description: Deploy ModelScope applications of model (stage 1)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig:
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-1}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '1'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  app_func_0:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-app-func-0
      description: Deploy ModelScope applications of model (stage 0)
      timeout: 1800
      memorySize: ${vars.memorySize}
      cpu: ${vars.vCPU}
      diskSize: 512
      gpuConfig:
        gpuMemorySize: ${vars.gpuMemorySize}
        gpuType: ${vars.gpuInstanceType}
      instanceConcurrency: ${vars.concurrency}
      runtime: custom-container
      initializer: 'true'
      initializationTimeout: 300
      internetAccess: true
      vpcConfig: ${vars.vpcConfig}
      nasConfig: 
        mountPoints:
          - serverAddr: ${vars.nasServerAddr-0}model-cache
            mountDir: ${vars.localModelCache}
          - serverAddr: ${vars.nasServerAddr-7}
            mountDir: ${vars.CommDir}
      customContainerConfig:
        image: registry.${vars.region}.aliyuncs.com/aliyun-fc/fc-modelscope-coldstart:v1
        port: 9000
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODELSCOPE_CACHE: ${vars.localModelCache}
        TASK: ${vars.modelTask}
        PP_RANK: '0'
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
        FUNC_NAME_BASE: ${vars.name}-model-app-func
        COMM_DIR: ${vars.CommDir}
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerModel'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT
  model_ui_func:
    component: 'fc3'
    props:
      region: ${vars.region}
      role: ${vars.role}
      functionName: ${vars.name}-model-ui-func
      description: model ui web page
      handler: index.handler
      timeout: 600
      memorySize: 1024
      instanceType: e1
      runtime: custom.debian10
      code: ./model_ui
      instanceConcurrency: ${vars.concurrency}
      internetAccess: true
      environmentVariables:
        MODEL_ID: ${vars.modelID}
        MODEL_VERSION: ${vars.modelRevision}
        TASK: ${vars.modelTask}
        PATH: /opt/python3.9/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin
        PYTHONPATH: /opt/python
        API_URL: ${resources.app_func_0.output.url.system_intranet_url}
        API_URL_1: ${resources.app_func_1.output.url.system_intranet_url}
        API_URL_2: ${resources.app_func_2.output.url.system_intranet_url}
        API_URL_3: ${resources.app_func_3.output.url.system_intranet_url}
        API_URL_4: ${resources.app_func_4.output.url.system_intranet_url}
        API_URL_5: ${resources.app_func_5.output.url.system_intranet_url}
        API_URL_6: ${resources.app_func_6.output.url.system_intranet_url}
        API_URL_7: ${resources.app_func_7.output.url.system_intranet_url}
        PP_SIZE: ${vars.ppSize}
        DEST_PP_SIZE: ${vars.destppSize}
      customRuntimeConfig:
        command:
          - python3.9
        args:
          - "app.py"
        port: 7860
      layers:
        - acs:fc:${vars.region}:official:layers/Python39/versions/2
        - acs:fc:${vars.region}:1431999136518149:layers/Python39-Gradio/versions/1
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          description: 'httpTriggerUI'
          qualifier: LATEST
          triggerConfig:
            authType: anonymous
            disableURLInternet: false
            methods:
              - GET
              - POST
              - PUT

  model_ui_func_domain:
    component: 'fc3-domain'
    props:
      region: ${vars.region}
      domainName: auto
      protocol: HTTP
      routeConfig:
        routes:
          - functionName: ${resources.model_ui_func.props.functionName}
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            path: /*
            qualifier: LATEST
